# OKR管理系统 - 计划视图和分数统计功能执行计划

## 计划元信息
- **项目名称**: 计划视图(Plan View)和分数趋势统计(Score Trend Statistics)功能
- **计划版本**: v1.0
- **创建日期**: 2025-07-11
- **预估工期**: 5个阶段，约12-15个工作单元
- **基础**: 基于现有OKR管理系统，添加新功能模块

## 功能概述

### 计划视图 (Plan View)
- 提供特定时间周期（年/季/月）的任务综合视图
- 显示任务的完整父级链（递归至顶层）
- 展示相关时间周期的日志条目
- API: `GET /api/plan?scale=quarter&time_ref=2024-Q4`

### 分数趋势统计 (Score Trend Statistics)
- 按时间粒度聚合任务分数和数量
- 支持日、月、季度等不同统计维度
- 返回时间序列数据用于图表展示
- API: `GET /api/stats/score-trend?scale=month&time_ref=2025-07`

## 执行策略

### 核心原则
1. **基于现有架构**: 复用现有的代码结构和模式
2. **增量开发**: 每个阶段产出可验证的功能
3. **向后兼容**: 不破坏现有功能
4. **测试保障**: 新功能必须有测试覆盖

### 技术约束
- 使用现有的Go技术栈和Echo框架
- 复用现有的Ent ORM和数据库结构
- 遵循现有的项目架构模式
- 保持API设计一致性

## Phase 1: 类型和结构定义 🔄

### 目标
扩展现有类型系统，添加新功能所需的数据结构

### 工作单元

#### 1.1 扩展枚举类型 (优先级: 高) ⏳
**依赖**: 无
**工作内容**:
- 在 `internal/types/enums.go` 中添加 TimeScale 枚举
- 支持 "year", "quarter", "month", "day" 等时间尺度
- 添加时间参考格式解析函数
- 实现时间范围计算工具函数

**输出结果**:
- TimeScale 枚举定义
- 时间解析和范围计算函数
- 相关的验证函数

**验收标准**:
- TimeScale 枚举包含所需值
- 能正确解析 "2024-Q4", "2025-07" 等格式
- 能准确计算时间范围的起止时间

#### 1.2 新增响应结构体 (优先级: 高) ⏳
**依赖**: 1.1完成
**工作内容**:
- 在 `internal/types/response.go` 中添加新的响应结构
- PlanRequest, PlanResponse 结构体
- ScoreTrendRequest, ScoreTrendResponse 结构体
- TaskTree 结构体（用于表示任务层级关系）

**输出结果**:
- 完整的请求/响应结构体定义
- JSON标签和验证标签完整
- 适当的文档注释

**验收标准**:
- 结构体定义符合设计文档
- JSON序列化/反序列化正常
- 字段验证规则正确

**Phase 1 里程碑**: 
- [ ] 新增类型定义完成并通过编译
- [ ] 时间处理函数测试通过
- [ ] 结构体序列化正常

## Phase 2: 数据层扩展 🔄

### 目标
扩展Repository层，添加支持新功能的数据查询方法

### 工作单元

#### 2.1 扩展TaskRepository (优先级: 高) ⏳
**依赖**: Phase 1完成
**工作内容**:
- 在 `internal/repository/task_repository.go` 中添加新方法
- GetTasksInTimeRange: 按时间范围查询任务
- GetTaskWithAncestors: 获取任务及其完整父级链
- GetTasksForPlanView: 为计划视图优化的任务查询

**输出结果**:
- 新的查询方法实现
- 优化的SQL查询逻辑
- 支持递归查询父级任务

**验收标准**:
- 能正确查询指定时间范围内的任务
- 递归查询父级链无死循环
- 查询性能在可接受范围内

#### 2.2 扩展JournalRepository (优先级: 中) ⏳
**依赖**: 2.1完成
**工作内容**:
- 在 `internal/repository/journal_repository.go` 中添加方法
- GetJournalsInTimeRange: 按时间范围查询日志
- GetJournalsWithTasksInRange: 获取指定时间范围内相关的日志

**输出结果**:
- 时间范围查询方法
- 关联查询优化

**验收标准**:
- 能准确按时间范围过滤日志
- 查询结果包含必要的关联数据
- 查询效率满足要求

#### 2.3 添加统计查询方法 (优先级: 中) ⏳
**依赖**: 2.2完成
**工作内容**:
- 创建专门的统计查询方法
- GetScoreAggregationByTime: 按时间聚合分数统计
- 支持不同时间粒度的聚合（日/月/季度）

**输出结果**:
- 聚合查询实现
- 时间分组逻辑
- 性能优化的SQL

**验收标准**:
- 聚合数据准确无误
- 支持各种时间粒度
- 查询性能良好

**Phase 2 里程碑**: 
- [ ] 所有新增查询方法实现完成
- [ ] 数据层单元测试通过
- [ ] 查询性能符合要求

## Phase 3: 业务层实现 🔄

### 目标
实现新功能的核心业务逻辑

### 工作单元

#### 3.1 扩展TaskService (优先级: 高) ⏳
**依赖**: Phase 2完成
**工作内容**:
- 在 `internal/service/interfaces.go` 中扩展 TaskService 接口
- 实现 GetPlanView 方法
- 实现任务树构建算法
- 处理时间范围解析和验证

**输出结果**:
- GetPlanView 方法实现
- 任务树构建逻辑
- 时间范围处理函数

**验收标准**:
- 能正确返回计划视图数据
- 任务树结构正确完整
- 时间范围处理准确

#### 3.2 创建StatsService (优先级: 高) ⏳
**依赖**: 3.1完成
**工作内容**:
- 创建新的 `internal/service/stats_service.go`
- 实现 StatsService 接口
- 实现 GetScoreTrend 方法
- 添加数据聚合和格式化逻辑

**输出结果**:
- 完整的 StatsService 实现
- 分数趋势统计逻辑
- 数据格式化函数

**验收标准**:
- 统计数据计算正确
- 支持所有要求的时间粒度
- 返回数据格式符合API设计

#### 3.3 业务层单元测试 (优先级: 中) ⏳
**依赖**: 3.2完成
**工作内容**:
- 为新增的Service方法编写单元测试
- 创建测试数据和Mock
- 测试各种边界条件和异常情况

**输出结果**:
- 完整的单元测试套件
- Mock实现
- 测试覆盖率报告

**验收标准**:
- 测试覆盖率>85%
- 所有测试用例通过
- 边界条件处理正确

**Phase 3 里程碑**: 
- [ ] 核心业务逻辑实现完成
- [ ] 业务层单元测试全部通过
- [ ] 功能逻辑验证正确

## Phase 4: 控制器和路由 🔄

### 目标
实现REST API接口，完成功能的对外暴露

### 工作单元

#### 4.1 创建PlanController (优先级: 高) ⏳
**依赖**: Phase 3完成
**工作内容**:
- 创建 `internal/controller/plan_controller.go`
- 实现 GetPlanView 处理函数
- 添加请求参数验证和错误处理
- 实现响应格式化

**输出结果**:
- PlanController 完整实现
- 请求验证逻辑
- 统一错误处理

**验收标准**:
- API响应格式正确
- 参数验证完整
- 错误处理统一

#### 4.2 扩展StatsController (优先级: 高) ⏳
**依赖**: 4.1完成
**工作内容**:
- 在现有 `internal/controller/stats_controller.go` 中添加方法
- 实现 GetScoreTrend 处理函数
- 复用现有的错误处理和验证逻辑

**输出结果**:
- 分数趋势API实现
- 参数处理逻辑
- 响应格式化

**验收标准**:
- API功能完整正确
- 与现有API风格一致
- 性能满足要求

#### 4.3 路由配置 (优先级: 中) ⏳
**依赖**: 4.2完成
**工作内容**:
- 在 `cmd/server/routes.go` 中添加新路由
- 配置JWT中间件保护
- 添加适当的HTTP方法和路径

**输出结果**:
- 新增路由配置
- 中间件应用正确
- 路由测试

**验收标准**:
- 路由配置正确
- 认证保护有效
- API可正常访问

**Phase 4 里程碑**: 
- [ ] 所有新API接口实现完成
- [ ] API功能测试通过
- [ ] 与现有系统集成正常

## Phase 5: 集成测试和完善 🔄

### 目标
进行端到端测试，完善功能细节

### 工作单元

#### 5.1 API集成测试 (优先级: 高) ⏳
**依赖**: Phase 4完成
**工作内容**:
- 编写计划视图API的集成测试
- 编写分数趋势API的集成测试
- 测试各种查询参数组合
- 验证数据一致性

**输出结果**:
- 完整的集成测试套件
- 测试数据脚本
- 测试报告

**验收标准**:
- 所有API集成测试通过
- 数据一致性验证通过
- 性能测试达标

#### 5.2 错误处理完善 (优先级: 中) ⏳
**依赖**: 5.1完成
**工作内容**:
- 完善异常情况处理
- 统一错误消息格式
- 添加适当的HTTP状态码
- 改进日志记录

**输出结果**:
- 完善的错误处理机制
- 统一的错误响应格式
- 详细的日志记录

**验收标准**:
- 异常情况处理完整
- 错误信息清晰有用
- 日志记录充分

#### 5.3 文档更新 (优先级: 低) ⏳
**依赖**: 5.2完成
**工作内容**:
- 更新API文档
- 添加使用示例
- 更新README
- 创建功能演示

**输出结果**:
- 更新的API文档
- 使用示例和说明
- 功能演示材料

**验收标准**:
- 文档准确完整
- 示例可以正常运行
- 说明清晰易懂

**Phase 5 里程碑**: 
- [ ] 所有功能完整实现并测试通过
- [ ] 错误处理和日志完善
- [ ] 文档更新完成

## 质量检查清单

### 代码质量
- [ ] Go代码格式化 (`go fmt`)
- [ ] 静态分析无警告 (`go vet`) 
- [ ] 单元测试覆盖率>80%
- [ ] 集成测试全部通过
- [ ] 代码审查通过

### 功能完整性
- [ ] 计划视图API功能正确
- [ ] 分数趋势API功能正确
- [ ] 时间范围处理准确
- [ ] 任务树构建正确
- [ ] 数据聚合计算准确

### 性能和安全
- [ ] API响应时间<200ms
- [ ] 数据库查询优化
- [ ] JWT认证保护有效
- [ ] 参数验证完整
- [ ] SQL注入防护

### 集成兼容性
- [ ] 不影响现有功能
- [ ] API设计风格一致
- [ ] 错误处理统一
- [ ] 日志格式一致
- [ ] 配置管理兼容

## 风险评估

### 技术风险
1. **复杂查询性能**: 任务树递归查询可能影响性能
   - **缓解**: 添加适当索引，使用CTE优化，考虑缓存
   
2. **时间处理复杂性**: 多种时间格式和计算逻辑
   - **缓解**: 充分的单元测试，边界条件验证

3. **数据一致性**: 统计数据与实际数据的一致性
   - **缓解**: 事务处理，定期数据校验

### 进度风险
1. **学习成本**: 理解现有代码架构需要时间
   - **缓解**: 先从简单功能开始，逐步深入

2. **测试复杂度**: 复杂的时间场景测试
   - **缓解**: 分阶段测试，自动化测试脚本

## 成功标准

### 功能标准
- ✅ 用户可以查看指定时间周期的计划视图
- ✅ 计划视图包含任务树和相关日志
- ✅ 用户可以查看任务分数趋势统计
- ✅ 支持多种时间粒度的统计查询
- ✅ API响应数据格式正确完整

### 技术标准
- ✅ 所有单元测试和集成测试通过
- ✅ 代码符合项目规范和最佳实践
- ✅ API性能满足要求（<200ms响应时间）
- ✅ 不破坏现有功能的正常运行
- ✅ 文档完整准确

### 质量标准
- ✅ 错误处理完整统一
- ✅ 日志记录充分有用
- ✅ 安全防护到位
- ✅ 代码可维护性良好

---

**当前进度**: 准备开始Phase 1
**下一步行动**: 开始扩展枚举类型定义
**预计完成时间**: 2025-07-16

**执行说明**: 
1. 严格按照Phase顺序执行
2. 每完成一个工作单元进行Git提交
3. 每完成一个Phase更新此文档
4. 遇到问题及时调整计划
5. 保持与现有代码风格一致
